import './polyfills.server.mjs';
import{d as T}from"./chunk-M3IOWYDM.mjs";import{$c as _,D as l,U as f,X as d,_ as I,_a as S,_c as m,da as u,g as p,l as o,m as n,r as c,z as g}from"./chunk-S7ATBOQE.mjs";import{a as h}from"./chunk-COT65Y5O.mjs";var w=(()=>{class s{constructor(e,t,r){this.http=e,this.router=t,this.ngZone=r,this.apiUrl="http://localhost/apis",this.currentUserSubject=new p(JSON.parse(localStorage.getItem("currentUser")||"{}")),this.currentUser=this.currentUserSubject.asObservable(),this.initAutoLogout()}get currentUserValue(){return this.currentUserSubject.value}login(e,t){return this.http.post(`${this.apiUrl}/login/`,{username:e,password:t},{headers:new m({"Content-Type":"application/json"})}).pipe(c(r=>(r&&r.access&&r.refresh&&(this.storeUserData(r),this.startTokenExpirationTimer()),r)))}clientLogin(e,t){return this.http.post(`${this.apiUrl}/login/`,{username:e,dob:t},{headers:new m({"Content-Type":"application/json"})}).pipe(c(r=>(r&&r.access&&r.refresh&&this.storeUserData(r),r)))}getUserRole(){let e=localStorage.getItem("user_type"),t=localStorage.getItem("employee_user_type");return e==="superuser"?"superuser":e==="employee"?t==="Admin"?"admin":"staff":e==="client"?"client":"guest"}getCurrentUser(){return{id:localStorage.getItem("user_id"),name:localStorage.getItem("user_name"),email:localStorage.getItem("user_email"),user_type:localStorage.getItem("user_type"),user_type_name:localStorage.getItem("user_type_name")}}getUserProfile(){let e=localStorage.getItem("user_type"),t=localStorage.getItem("user_id");return e==="employee"&&t?this.getEmployeeProfile(t):e==="client"?this.getClientProfile():e==="superuser"?this.getSuperuserProfile():n(()=>new Error("Unknown user type"))}getSuperuserProfile(){let e={id:localStorage.getItem("user_id")||"",name:localStorage.getItem("user_name")||localStorage.getItem("username")||"",email:localStorage.getItem("user_email")||"",user_type:"superuser",user_type_name:"Superuser"};return o(e)}getEmployeeProfile(e){let t=localStorage.getItem("access_token");if(!t)return n(()=>new Error("No access token found"));let r=new m({Authorization:`Bearer ${t}`});return this.http.get(`${this.apiUrl}/employee/${e}/`,{headers:r}).pipe(d(a=>{let i=h(h({},this.currentUserValue),a);this.handleAuthentication(i)}),l(this.handleError))}getClientProfile(){let e={id:localStorage.getItem("user_id")||"",name:localStorage.getItem("user_name")||"",email:localStorage.getItem("user_email")||"",user_type:"client",user_type_name:"Client"};return o(e)}handleError(e){let t="An unknown error occurred!";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:e.error&&typeof e.error=="object"&&"detail"in e.error?t=e.error.detail:t=`Error Code: ${e.status}
Message: ${e.message}`,console.error(t),n(()=>new Error(t))}handleAuthentication(e){this.updateCurrentUser(e),localStorage.setItem("currentUser",JSON.stringify(e))}logout(){let e=localStorage.getItem("refresh_token");return this.http.post(`${this.apiUrl}/logout/`,{refresh_token:e}).pipe(c(()=>{this.clearUserData(),this.stopTokenExpirationTimer(),this.stopInactivityTimer()}),l(t=>(console.error("Logout error:",t),this.clearUserData(),this.stopTokenExpirationTimer(),this.stopInactivityTimer(),n(()=>t))))}get isAuthenticated(){return!!this.currentUserValue&&!!localStorage.getItem("access_token")}storeUserData(e){localStorage.setItem("currentUser",JSON.stringify(e)),localStorage.setItem("access_token",e.access),localStorage.setItem("refresh_token",e.refresh),localStorage.setItem("user_type",e.user_type),localStorage.setItem("user_id",e.user_id),localStorage.setItem("user_name",e.name||e.username),localStorage.setItem("user_email",e.email),localStorage.setItem("user_type_name",e.user_type_name),this.updateCurrentUser(e)}clearUserData(){localStorage.removeItem("currentUser"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user_type"),localStorage.removeItem("user_id"),localStorage.removeItem("user_name"),localStorage.removeItem("user_email"),localStorage.removeItem("user_type_name"),this.updateCurrentUser(null)}updateCurrentUser(e){this.currentUserSubject.next(e)}initAutoLogout(){this.isAuthenticated&&(this.startTokenExpirationTimer(),this.startInactivityTimer())}startTokenExpirationTimer(){this.stopTokenExpirationTimer();let e=localStorage.getItem("access_token");if(e){let r=this.decodeJwt(e).exp*1e3,a=Date.now(),i=r-a;i>0?this.tokenExpirationTimer=g(i).pipe(f(()=>this.refreshToken())).subscribe({next:y=>{y?(console.log("Token refreshed successfully"),this.startTokenExpirationTimer()):(console.error("Failed to refresh token"),this.autoLogout())},error:()=>{console.error("Error in token refresh process"),this.autoLogout()}}):this.autoLogout()}}stopTokenExpirationTimer(){this.tokenExpirationTimer&&this.tokenExpirationTimer.unsubscribe()}startInactivityTimer(){this.stopInactivityTimer(),this.inactivityTimer=g(30*60*1e3).subscribe(()=>{this.autoLogout()})}stopInactivityTimer(){this.inactivityTimer&&this.inactivityTimer.unsubscribe()}resetInactivityTimer(){this.startInactivityTimer()}autoLogout(){this.ngZone.run(()=>{this.clearUserData(),this.router.navigate(["/login"],{queryParams:{returnUrl:this.router.url}})})}refreshToken(){let e=localStorage.getItem("refresh_token");return e?this.http.post(`${this.apiUrl}/token/refresh/`,{refresh:e}).pipe(c(t=>t&&t.access?(localStorage.setItem("access_token",t.access),t.refresh&&localStorage.setItem("refresh_token",t.refresh),this.startTokenExpirationTimer(),this.resetInactivityTimer(),!0):!1),l(t=>(console.error("Error refreshing token:",t),this.autoLogout(),o(!1)))):o(!1)}checkTokenValidity(){let e=localStorage.getItem("access_token");if(!e)return o(!1);let t=this.decodeJwt(e),r=Date.now()/1e3;return t.exp<r?this.refreshToken():o(!0)}decodeJwt(e){let r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(r).split("").map(function(i){return"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(a)}refreshUserSession(){this.isAuthenticated&&this.resetInactivityTimer()}static{this.\u0275fac=function(t){return new(t||s)(u(_),u(T),u(S))}}static{this.\u0275prov=I({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{w as a};
